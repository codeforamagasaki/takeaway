"use strict";var Takeaway=function(){var e="initialize";const t=["yes","no"],a=[[/Mo/g,"月"],[/Tu/g,"火"],[/We/g,"水"],[/Th/g,"木"],[/Fr/g,"金"],[/Sa/g,"土"],[/Su/g,"日"],[/;/g,"<br>"],[/PH/g,"祝日"],[/off/g,"休業"],[/24\/7/g,"24時間営業"]];return{status:()=>e,get:function(t,a){console.log("Takeaway: get start..."),e="get";var o=[];if(void 0==t||""==t)for(let e in Conf.target)o.push(e);else o=t;map.getZoom()<Conf.local.MinZoomLevel?(console.log("Takeaway: get end(Conf.local.MinZoomLevel)."),Takeaway.update(),a()):OvPassCnt.get(o).then(e=>{o.forEach(t=>{PoiData[t].geojson=e[t]}),Takeaway.update(),console.log("Takeaway: get end."),a()}).catch((e,t,o)=>{console.log("Takeaway: get Error. "+t),Takeaway.update(),a()})},update:function(t){let a=map.getZoom();if(""==t||void 0===t)for(let e in Conf.target)Marker.all_delete(e),Conf.target[e].zoom<=a&&Marker.set(e);else Marker.all_delete(t),Conf.target[t].zoom<=a&&Marker.set(t);e=""},view:function(o){e="view",DataList.select(o.id);let l,n,i=o.id;history.replaceState("","",location.pathname+"?"+i+location.hash),$("#osmid").html(o.id),$("#name").html(null==o.name?"-":o.name),$("#category-icon").attr("src",o.takeaway_icon),$("#category").html(Takeaway.get_catname(o)),l=o["opening_hours:covid19"]?o["opening_hours:covid19"]:null==o.opening_hours?"-":o.opening_hours,a.forEach(e=>{l=l.replace(e[0],e[1])}),o["opening_hours:covid19"]&&(l+=Conf.category.suffix_covid19),$("#opening_hours").html(l),n=null!=o["delivery:covid19"]?Conf.category.delivery[o["delivery:covid19"]]+Conf.category.suffix_covid19:null==o.delivery?"-":Conf.category.delivery[o.delivery],$("#delivery").html(n);let r=t.indexOf(o.outdoor_seating)<0?"-":o.outdoor_seating;$("#outdoor_seating").html(r),"-"!==r&&$("#outdoor_seating").attr("glot-model","outdoor_seating_"+r),null!=o["contact:phone"]?($("#phone").attr("href","tel:"+o["contact:phone"]),$("#phone_view").html(o["contact:phone"])):null!=o.phone?($("#phone").attr("href","tel:"+o.phone),$("#phone_view").html(o.phone)):$("#phone_view").html("-"),null!=o["contact:email"]?($("#email").attr("href","mailto:"+o["contact:email"]),$("#email_view").html(o["contact:email"])):null!=o.email?($("#email").attr("href","mailto:"+o.email),$("#email_view").html(o.email)):$("#email_view").html("-"),null!=o["contact:website"]?($("#url").attr("href",o["contact:website"]),$("#url_view").html("公式サイト")):null!=o.website?($("#url").attr("href",o.website),$("#url_view").html("公式サイト")):$("#url_view").html("-"),null!=o["contact:facebook"]?($("#facebook").attr("href",o["contact:facebook"]),$("#facebook_view").html("facebook")):$("#facebook_view").html("-"),null!=o["contact:instagram"]?($("#instagram").attr("href",o["contact:instagram"]),$("#instagram_view").html("instagram")):$("#instagram_view").html("-"),null!=o["contact:twitter"]?($("#twitter").attr("href",o["contact:twitter"]),$("#twitter_view").html("twitter")):$("#twitter_view").html("-"),null!=o["contact:line"]?($("#line").attr("href",o["contact:line"]),$("#line_view").html("line")):$("#line_view").html("-"),null!=o["addr:city"]||null!=o["addr:quarter"]||null!=o["addr:neighbourhood"]||null!=o["addr:block_number"]||null!=o["addr:housenumber"]?$("#addr").html((null==o["addr:city"]?"":o["addr:city"])+(null==o["addr:quarter"]?"":o["addr:quarter"])+(null==o["addr:neighbourhood"]?"":o["addr:neighbourhood"])+(null==o["addr:block_number"]?"":"-"+o["addr:block_number"])+(null==o["addr:housenumber"]?"":"-"+o["addr:housenumber"])):$("#addr").html("-"),null!=o.description||null!=o["takeaway:description"]||null!=o["delivery:description"]?$("#description").html((null==o.description?"":o.description+"<br>")+(null==o["takeaway:description"]?"":o["takeaway:description"]+"<br>")+(null==o["delivery:description"]?"":o["delivery:description"])):$("#description").html("-"),glot.render(),$("#PoiView_Modal").modal({backdrop:"static",keyboard:!0});let s=t=>{e="",history.replaceState("","",location.pathname+location.hash),$("#PoiView_Modal").modal("hide")};$("#PoiView_Modal").one("hidePrevented.bs.modal",s),$("#PoiView_Modal").one("hidden.bs.modal",s)},openmap:e=>{let t=Marker.get(e),a=map.getZoom(),o=void 0==t.tag.name?"":"search/"+t.tag.name+"/";window.open("https://www.google.com/maps/"+o+"@"+t.ll.lat+","+t.ll.lng+","+a+"z")},sharemap:e=>{let t=e.replace("/","-"),a=location.origin+location.pathname+"?"+t+location.hash;$(document.body).append('<textarea id="copyTarget" style="position:absolute; left:-9999px; top:0px;">'+a+"</textarea>");let o=document.getElementById("copyTarget"),l=document.createRange();l.selectNode(o),window.getSelection().addRange(l),document.execCommand("copy"),$("#copyTarget").remove(),$("#copied").addClass("copied")},sharemapEnd:()=>{$("#copied").removeClass("copied")},editmap:e=>{let t=Marker.get(e),a=map.getZoom();void 0==t.tag.name||t.tag.name;window.open("https://www.mapcontrib.xyz/t/1c17e9#position/"+a+"/"+t.ll.lat+"/"+t.ll.lng)},get_catname:function(e){let t="";var a=void 0==e.amenity?"shop":"amenity",o=void 0==e[a]?"":e[a];return""!==o&&void 0==(t=Conf.category[a][o])&&(t=""),t},calc_between:function(e,t){let a=Math.PI,o=e.lat*(a/180),l=e.lng*(a/180),n=t.lat*(a/180),i=(o-n)/2,r=(l-t.lng*(a/180))/2;return 12756274*Math.asin(Math.sqrt(Math.pow(Math.sin(i),2)+Math.cos(o)*Math.cos(n)*Math.pow(Math.sin(r),2)))}}}(),Marker=function(){var e={radius:8,color:"#000080",fillColor:"#0000A0",Opacity:.1,fillOpacity:.1},t={},a={};return{get:e=>({ll:t[e],tag:a[e]}),set:function(e){let o=PoiData[e].geojson,l=[];void 0!==o&&(o.features.forEach(function(o){let n=o.properties.tags;$.extend(n,{id:o.properties.id,timestamp:new Date(o.properties.meta.timestamp)});let i=L.divIcon({className:"icon",html:'<img class="icon" src="'+Conf.target[e].icon+'">'});"Polygon"==o.geometry.type?t[n.id]={lat:o.geometry.coordinates[0][0][1],lng:o.geometry.coordinates[0][0][0]}:t[n.id]={lat:o.geometry.coordinates[1],lng:o.geometry.coordinates[0]},a[n.id]=n,a[n.id].takeaway_icon=Conf.target[e].icon,l.push(L.marker(new L.LatLng(t[n.id].lat,t[n.id].lng),{icon:i,draggable:!1})),l[l.length-1].addTo(map).on("click",e=>Takeaway.view(e.target.takeaway_tags)),l[l.length-1].takeaway_tags=n}),PoiData[e].markers=l)},all_delete:function(e){void 0!==PoiData[e].markers&&(PoiData[e].markers.forEach(e=>e.remove(map)),PoiData[e].markers=void 0)},list:function(e){let a=[];return e.forEach(e=>{void 0!==PoiData[e].markers&&PoiData[e].markers.forEach(e=>{let o=e.takeaway_tags,l=new Date((new Date).getFullYear(),(new Date).getMonth(),(new Date).getDate()-7),n=void 0==o.name?"-":o.name+(l<o.timestamp?'<span class="updated"></span>':""),i=Takeaway.get_catname(o),r=Math.round(Takeaway.calc_between(t[o.id],map.getCenter()));a.push({osmid:o.id,name:n,category:i,between:r})})}),a.sort((e,t)=>e.between>t.between?1:-1),a.filter(function(e,t,a){return a.findIndex(t=>t.osmid==e.osmid)==t})},center:a=>{map.panTo(t[a],{animate:!0,easeLinearity:.1,duration:.5}),e.radius=Math.pow(2,21-map.getZoom());let o=L.circle(t[a],e).addTo(map);setTimeout(()=>map.removeLayer(o),2e3)},event_move:e=>{switch(console.log("moveend: event start."),LL.NW=map.getBounds().getNorthWest(),LL.SE=map.getBounds().getSouthEast(),LL.busy){case!0:clearTimeout(LL.id);default:LL.busy=!0,"initialize"==Takeaway.status()?Takeaway.get("",()=>{if(DataList.view(DataList_Targets),DisplayStatus.splash(!1),""!==location.search){let e=location.search.replace(/[?&]fbclid.*/,"");e=(e=e.replace("-","/")).replace("=","");let t=Marker.get(e.slice(1));void 0!==t.tag&&Takeaway.view(t.tag)}LL.busy=!1}):LL.id=setTimeout(()=>{Takeaway.get("",()=>{DataList.view(DataList_Targets)}),LL.busy=!1},1e3)}}}}(),DataList=function(){var e,t="",a=!1,o=0;return{status:()=>t,table:()=>e,lock:e=>{a=e},init:()=>{document.getElementById("keyword").addEventListener("input",e=>{o>0&&(window.clearTimeout(o),o=0),o=window.setTimeout(()=>DataList.filter(e.target.value),500)}),document.getElementById("category_list").addEventListener("change",e=>{let t="-"==e.target.value?"":e.target.value;DataList.filter(t)})},make_select:e=>{let t=[];DisplayStatus.clear_select("category_list"),(t=(t=e.map(e=>e.category)).filter((e,t,a)=>a.indexOf(e)===t)).map(e=>DisplayStatus.add_select("category_list",e,e))},view:function(o){DataList.lock(!0),void 0!==e&&e.destroy();let l=Marker.list(o);e=$("#tableid").DataTable({autoWidth:!0,columns:[{title:"名前",data:"name",width:"40%"},{title:"種類",data:"category",width:"30%"},{title:"距離",data:"between",width:"20%"}],columnDefs:[{targets:2,render:$.fn.dataTable.render.number(",",".",0,"","m")}],data:l,processing:!0,filter:!0,destroy:!0,deferRender:!0,dom:"t",language:Conf.datatables_lang,order:[2,"asc"],ordering:!1,orderClasses:!1,paging:!0,processing:!1,pageLength:1e5,select:"single",scrollCollapse:!0,scrollY:$("#dataid").height()-32+"px"}),DataList.make_select(l);let n=void 0==e.row(0).data()?void 0:e.row(0).data().osmid;void 0!==n&&DataList.select(n),e.on("select",function(o,l,n,i){if(a)e.row(i).deselect();else if(""==t){var r=e.row(i).data();e.off("select"),Marker.center(r.osmid)}}),DataList.lock(!1)},select:function(a){t="select",e.rows().deselect();let o=e.data(),l=0;for(let e in o)if(o[e].osmid==a){l=e;break}l>=0&&(e.row(l).select(),e.row(l).node().scrollIntoView(!0)),t=""},filter:t=>{e.search(t).draw()}}}(),OvPassCnt=function(){var e={},t={NW:{lat:0,lng:0},SE:{lat:0,lng:0}};return{get:function(a){return new Promise((o,l)=>{let n=map.getZoom(),i=Object.keys(Conf.target).length;if(LL.NW.lat<t.NW.lat&&LL.NW.lng>t.NW.lng&&LL.SE.lat>t.SE.lat&&LL.NW.lat<t.NW.lat){console.log("OvPassCnt: Cache Hit.");let t={};a.forEach(a=>{t[a]=e[a]}),o(t)}else{DisplayStatus.progress(0),e={};let r=n-Conf.local.MinZoomLevel<1?.125:(n-Conf.local.MinZoomLevel)/4,s=(LL.NW.lat-LL.SE.lat)*r,d=(LL.SE.lng-LL.NW.lng)*r,c=LL.SE.lat-s,m=LL.SE.lng+d,g=LL.NW.lat+s,u=LL.NW.lng-d,h="("+c+","+u+","+g+","+m+");";t={SE:{lat:c,lng:m},NW:{lat:g,lng:u}};let p=[],f=0;a.forEach(e=>{let t="";for(let a in OverPass[e])t+=OverPass[e][a]+h;let a=OvServer+"?data=[out:json][timeout:30];("+t+");(._;>;);out meta qt;";console.log("GET: "+a),p.push($.get(a,()=>{DisplayStatus.progress(Math.ceil(100*(++f+1)/i))}))}),$.when.apply($,p).done(function(){let t=0;a.forEach(a=>{"success"!==(void 0==arguments[0][1]?arguments[1]:arguments[t][1])&&(alert(OvGetError),l());let o=arguments[t++][0],n=osmtogeojson(o,{flatProperties:!1});n.features.forEach(function(e){delete e.id}),n=n.features.filter(e=>{if(""!==Takeaway.get_catname(e.properties.tags))return e}),e[a]={features:n}}),console.log("OvPassCnt: Cache Update"),DisplayStatus.progress(0),o(e)}).fail(function(e,t,a){console.log(t),l(e,t,a)})}})}}}(),DisplayStatus={splash:e=>{$("#splash_image").attr("src",Conf.local.SplashImage);let t=e?{backdrop:"static",keyboard:!1}:"hide";$("#Splash_Modal").modal(t)},make_menu:()=>{Object.keys(Conf.menu).forEach(e=>{$("#temp_menu>a:first").attr("href",Conf.menu[e].linkto),$("#temp_menu>a>span:first").attr("glot-model",Conf.menu[e]["glot-model"]);let t=$("#temp_menu>a:first").clone();$("#temp_menu").append(t),Conf.menu[e].divider&&$("#temp_menu>div:first").clone().appendTo($("#temp_menu"))}),$("#temp_menu>a:first").remove(),$("#temp_menu>div:first").remove()},progress:e=>{e=0==e?.1:e,$("#Progress_Bar").css("width",parseInt(e)+"%")},morezoom:e=>{if(!$("#morezoom").length){let e=L.control({position:"topleft"});e.onAdd=function(e){return this.ele=L.DomUtil.create("div","morezoom"),this.ele.id="morezoom",this.ele},e.addTo(map)}""!==e?$("#morezoom").html("<h1>"+e+"</h1>"):$("#morezoom").html("")},add_select:(e,t,a)=>{let o=document.createElement("option");o.text=t,o.value=a,document.getElementById(e).appendChild(o)},clear_select:e=>{$("#"+e+" option").remove(),$("#"+e).append($("<option>").html("---").val("-"))},window_resize:()=>{console.log("Window Width: "+window.innerWidth);let e,t=window.innerWidth<768?.7:1;switch(t){case 1:e=window.innerHeight-40,$("#mapid").css("height",Math.round(e*t)+"px"),$("#dataid").css("height",window.innerHeight-90+"px");break;default:e=window.innerHeight-80;let a=Math.round(e*t),o=e-a;$("#mapid").css("height",a+"px"),$("#dataid").css("height",o+"px")}}};